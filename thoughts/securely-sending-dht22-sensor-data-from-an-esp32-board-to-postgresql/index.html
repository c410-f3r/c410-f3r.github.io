<!--
    All icons belong to Font Awesome. Please, see https://fontawesome.com/license/free for 
    more information.
-->

<!DOCTYPE html>
<html lang="en">

<head>
    <link href="https://fonts.googleapis.com/css?family=Comfortaa" rel="stylesheet">
    <link href="https://c410-f3r.github.io/index.css" rel="stylesheet">
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Caio&#x27;s Stuff</title>
</head>

<body>
    <div class="container">
        <div class="rounded-box">
            <header>
                <nav class="is-size-5 navbar" role="navigation" aria-label="main navigation">
                    <div class="navbar-brand">
                        <a class="is-family-secondary is-paddingless is-size-4 has-text-weight-bold navbar-item" href="/" title = "Caio's stuff">Caio's Stuff</a>

                        <a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false"
                            data-target="topMenu">
                            <span aria-hidden="true"></span>
                            <span aria-hidden="true"></span>
                            <span aria-hidden="true"></span>
                        </a>
                    </div>

                    <div class="has-text-weight-light navbar-menu" id="topMenu">
                        <div class="navbar-end">
                            
                            <a class="navbar-item px-4 underline" href="&#x2F;certifications" title="Certifications">
                                <span class="icon">
                                    <figure class="image is-16x16">
                                        <img alt="Certifications" class="image is-16x16" src="&#x2F;fontawesome&#x2F;lightbulb.svg">
                                    </figure>
                                </span>
                                <span>Certifications</span>
                            </a>
                            
                            <a class="navbar-item px-4 underline" href="&#x2F;courses" title="Courses">
                                <span class="icon">
                                    <figure class="image is-16x16">
                                        <img alt="Courses" class="image is-16x16" src="&#x2F;fontawesome&#x2F;school.svg">
                                    </figure>
                                </span>
                                <span>Courses</span>
                            </a>
                            
                            <a class="navbar-item px-4 underline" href="&#x2F;cover-letter" title="Cover letter">
                                <span class="icon">
                                    <figure class="image is-16x16">
                                        <img alt="Cover letter" class="image is-16x16" src="&#x2F;fontawesome&#x2F;envelope.svg">
                                    </figure>
                                </span>
                                <span>Cover letter</span>
                            </a>
                            
                            <a class="navbar-item px-4 underline" href="&#x2F;curriculum.pdf" title="Curriculum">
                                <span class="icon">
                                    <figure class="image is-16x16">
                                        <img alt="Curriculum" class="image is-16x16" src="&#x2F;fontawesome&#x2F;list.svg">
                                    </figure>
                                </span>
                                <span>Curriculum</span>
                            </a>
                            
                        </div>
                    </div>
                </nav>
            </header>

            <main>
                

<article>
    <header>
        <h3 class="is-3 title">
            Securely sending DHT22 sensor data from an ESP32 board to PostgreSQL
        </h3>
    </header>
    <section>
        <div class="content">
            <figure class="image">
  <img src="/thoughts/securely-sending-dht22-sensor-data-from-an-esp32-board-to-postgresql/intro.jpg" alt="Introduction">
</figure>
<p>Let's collect data provided by a DHT22 sensor and store it asynchronously in a <a href="https://www.postgresql.org">PostgreSQL</a> database via WiFi using an encrypted connection. We will start with a brief introduction about the principal technologies, proceed to setting-up the necessary environment and then code our project.</p>
<p>The majority of the applications use Rust in a restricted <code>no_std</code> environment. If you are unfamiliar with Rust, take a look at <a href="https://doc.rust-lang.org/book">https://doc.rust-lang.org/book</a>.</p>
<p>As far as I can tell, there are no resources on the internet that tackles direct encrypted access to <a href="https://www.postgresql.org">PostgreSQL</a> with ESP32 or any other embedded device. Although not as powerful as HTTP requests, the approach shown here can be considered novel.</p>
<p>The final product is available at <a href="https://github.com/c410-f3r/blog-posts">https://github.com/c410-f3r/blog-posts</a> in the <code>esp32-postgresql</code> directory.</p>
<h2 id="technologies">Technologies</h2>
<p>This section won't focus on toolchains, system dependencies or auxiliary CLI tools. Instead, it will provide a brief introduction about the primary softwares/crates alongside the hardware components. If desirable, you can skip to the "Set-up" section</p>
<h4 id="wtx">WTX</h4>
<p><a href="https://github.com/c410-f3r/wtx">WTX</a> is, among other things, a <a href="https://datatracker.ietf.org/doc/html/rfc6455">RFC6455</a>, <a href="https://datatracker.ietf.org/doc/html/rfc7541">RFC7541</a>, <a href="https://datatracker.ietf.org/doc/html/rfc7692">RFC7692</a>, <a href="https://datatracker.ietf.org/doc/html/rfc8441">RFC8441</a> and <a href="https://datatracker.ietf.org/doc/html/rfc9113">RFC9113</a> implementation intended to allow the development of web applications through a built-in server framework, a built-in <code>PostgreSQL</code> connector, a built-in <code>WebSocket</code> handler and a built-in <code>gRPC</code> manager. There is also a built-in API client framework that facilitates the maintainability of large endpoints.</p>
<p>Every feature is optional and must be set at compile time. We are only going to use <a href="https://www.postgresql.org">PostgreSQL</a> but <a href="https://github.com/c410-f3r/wtx">WTX</a> is flexible enough to even serve <code>gRPC</code> requests on ESP32 devices.</p>
<p>Some query benchmarks are available at <a href="https://github.com/diesel-rs/metrics">https://github.com/diesel-rs/metrics</a>.</p>
<h4 id="esp32-wrover-e">ESP32-WROVER-E</h4>
<p>ESP32 is a series of low-cost, low-power system-on-chip microcontrollers created and developed by Espressif Systems, a Chinese company based in Shanghai.</p>
<p>Specifically, the <code>ESP32-WROVER-E</code> is a 32-bit dual-core development board with WiFi, 448 KiB of ROM, 520 KiB of RAM, Bluetooth, 4 MiB of Flash, built-in PCB antenna, 40 different pins, a camera and several other features. Quite affordable considering the place where I live.</p>
<h4 id="embedded-tls">Embedded-TLS</h4>
<p>Pure Rust implementation of the TLS 1.3 protocol designed for embedded systems, this crate provides synchronous and asynchronous interfaces as well as integration with <code>embassy</code> or <code>tokio</code>. The authors currently state that development is still in progress but <a href="https://github.com/drogue-iot/embedded-tls">Embedded-TLS</a> was capable of successfully establishing an encrypted connection with <a href="https://www.postgresql.org">PostgreSQL</a>.</p>
<p>If you are curious, <code>rustls</code> with its "raw buffered" interface couldn't be used because <code>alloc::sync::Arc</code> is hard-coded in the interface and the tested board doesn't provide native support for such primitive structure.</p>
<h4 id="esp32-crates">ESP32 crates</h4>
<p>The embedded world is generally dominated by C toolchains but thankfully, we are now witnessing a growing shift towards Rust-based alternatives. Espressif Systems, for example, provides <em><strong>official</strong></em> libraries, documentation and tools that can help creating, compiling, debugging and deploying binaries.</p>
<p>Some <a href="https://embassy.dev/">Embassy</a> crates will also be used to provide other synergic functionalities like a runtime executor or a TCP connector.</p>
<h4 id="dht22">DHT22</h4>
<p>A low-cost sensor used for measuring temperature and humidity approximately once every 2 seconds. Temperatures vary from -40°C to 80°C with an average accuracy of 0.5°C and humidity varies from 0% to 100% with an average accuracy of 2%.</p>
<p>There are versions with built-in resistors, which isn't the case for 4-pins variants that require an external resistor ranging from 4.7kΩ to 10kΩ.</p>
<p>Local tests unfortunately reported intermittent reads and halts. It is unclear whether these issues resulted from pre-existing manufacturing defects.</p>
<h2 id="set-up">Set-up</h2>
<p>Setting up a development environment for non-mainstream architectures often takes a surprising amount of time. A missing compiler flag can completely break your build and finding help for these niche setups can be difficult due to the usual lack of online resources.</p>
<p>It wasn't so difficult for ESP32 but there are a bunch of things that need to be taken into consideration, let's get to work.</p>
<h4 id="schematic">Schematic</h4>
<p>The following image illustrates all necessary connections powered by a 3.3V line.</p>
<figure class="image">
  <img src="/thoughts/securely-sending-dht22-sensor-data-from-an-esp32-board-to-postgresql/schematic.webp" alt="Schematic">
  <figcaption>Photo retrieved from https://capsistema.com.br</figcaption>
</figure>
<h4 id="local-tools">Local tools</h4>
<p>ESP32 processors are increasingly entering in the <code>LLVM</code> main branch and consequently in <code>rustc</code>. For example, the Xtensa architecture was merged as a tier 3 target a few months ago (<a href="https://github.com/rust-lang/rust/pull/126380">https://github.com/rust-lang/rust/pull/126380</a>).</p>
<p>There is still work to do until a fully feature-complete toolchain is natively available for users. In the meanwhile we will have to use custom toolchains provided by <code>espup</code>.</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">cargo</span><span> install espup
</span><span style="color:#bf616a;">cargo</span><span> install espflash
</span><span style="color:#bf616a;">espup</span><span> install
</span></code></pre>
<p><code>espflash</code> is responsible for flashing/deploying the final binary to the physical hardware and it is automatically called when running <code>cargo run</code>.</p>
<p>The setting up of environment variables is another important development aspect. Take a look at <a href="https://docs.esp-rs.org/book/installation/riscv-and-xtensa.html">https://docs.esp-rs.org/book/installation/riscv-and-xtensa.html</a> to see the best approach for you.</p>
<h4 id="cargo">Cargo</h4>
<p>Mentioning what someone once said: "Cargo is a gift sent by god."</p>
<p>Exaggerations aside, <code>Cargo</code> is indeed a very handy tool especially if you come from the C/C++ world where the building of applications isn't always very trivial.</p>
<p>Starting with the file tree of our application.</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>/esp32-postgresql
</span><span>├── .cargo
</span><span>│   └── config.toml
</span><span>├── src
</span><span>│   └── main.rs
</span><span>├── build.rs
</span><span>├── Cargo.toml
</span><span>└── rust-toolchain
</span></code></pre>
<p>Use the toolchain installed by <code>espup</code>.</p>
<pre data-lang="toml" style="background-color:#2b303b;color:#c0c5ce;" class="language-toml "><code class="language-toml" data-lang="toml"><span style="color:#65737e;"># rust-toolchain
</span><span>
</span><span>[toolchain]
</span><span style="color:#bf616a;">channel </span><span>= &quot;</span><span style="color:#a3be8c;">esp</span><span>&quot;
</span></code></pre>
<p>Set the custom linking script.</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#65737e;">// build.rs
</span><span>
</span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">main</span><span>() {
</span><span>  println!(&quot;</span><span style="color:#a3be8c;">cargo:rustc-link-arg-bins=-Tlinkall.x</span><span>&quot;);
</span><span>}
</span></code></pre>
<p>Instruct <code>rustc</code> to build for the <code>xtensa-esp32-none-elf</code> target alongside other additional parameters that can't be proxied with <code>Cargo</code>.</p>
<pre data-lang="toml" style="background-color:#2b303b;color:#c0c5ce;" class="language-toml "><code class="language-toml" data-lang="toml"><span style="color:#65737e;"># config.toml
</span><span>
</span><span>[target.xtensa-esp32-none-elf]
</span><span style="color:#bf616a;">runner </span><span>= &quot;</span><span style="color:#a3be8c;">espflash flash --monitor</span><span>&quot;
</span><span>
</span><span>[build]
</span><span style="color:#bf616a;">rustflags </span><span>= [&quot;</span><span style="color:#a3be8c;">-C</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">link-arg=-nostartfiles</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">-C</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">link-arg=-Trom_functions.x</span><span>&quot;]
</span><span>
</span><span style="color:#bf616a;">target </span><span>= &quot;</span><span style="color:#a3be8c;">xtensa-esp32-none-elf</span><span>&quot;
</span><span>
</span><span>[unstable]
</span><span style="color:#bf616a;">build-std </span><span>= [&quot;</span><span style="color:#a3be8c;">alloc</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">core</span><span>&quot;]
</span></code></pre>
<p>Declare the necessary dependencies. The list is big but necessary.</p>
<pre data-lang="toml" style="background-color:#2b303b;color:#c0c5ce;" class="language-toml "><code class="language-toml" data-lang="toml"><span style="color:#65737e;"># Cargo.toml
</span><span>
</span><span>[dependencies]
</span><span style="color:#65737e;"># Schedules asynchronous tasks for completion
</span><span style="color:#bf616a;">embassy-executor </span><span>= { </span><span style="color:#bf616a;">default-features </span><span>= </span><span style="color:#d08770;">false</span><span>, </span><span style="color:#bf616a;">features </span><span>= [&quot;</span><span style="color:#a3be8c;">task-arena-size-32768</span><span>&quot;], </span><span style="color:#bf616a;">version </span><span>= &quot;</span><span style="color:#a3be8c;">0.6</span><span>&quot; }
</span><span>
</span><span style="color:#65737e;"># Plain TCP connection
</span><span style="color:#bf616a;">embassy-net </span><span>= { </span><span style="color:#bf616a;">default-features </span><span>= </span><span style="color:#d08770;">false</span><span>, </span><span style="color:#bf616a;">features </span><span>= [&quot;</span><span style="color:#a3be8c;">tcp</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">dhcpv4-hostname</span><span>&quot;], </span><span style="color:#bf616a;">version </span><span>= &quot;</span><span style="color:#a3be8c;">0.4</span><span>&quot; }
</span><span>
</span><span style="color:#65737e;"># Reads DHT22 data
</span><span style="color:#bf616a;">embedded-dht-rs </span><span>= { </span><span style="color:#bf616a;">default-features </span><span>= </span><span style="color:#d08770;">false</span><span>, </span><span style="color:#bf616a;">features </span><span>= [&quot;</span><span style="color:#a3be8c;">dht22</span><span>&quot;], </span><span style="color:#bf616a;">version </span><span>= &quot;</span><span style="color:#a3be8c;">0.3</span><span>&quot; }
</span><span>
</span><span style="color:#65737e;"># Enables TLS 1.3 connection
</span><span style="color:#bf616a;">embedded-tls </span><span>= { </span><span style="color:#bf616a;">default-features </span><span>= </span><span style="color:#d08770;">false</span><span>, </span><span style="color:#bf616a;">git </span><span>= &quot;</span><span style="color:#a3be8c;">https://github.com/drogue-iot/embedded-tls</span><span>&quot; }
</span><span>
</span><span style="color:#65737e;"># Allocates heap memory
</span><span style="color:#bf616a;">esp-alloc </span><span>= { </span><span style="color:#bf616a;">default-features </span><span>= </span><span style="color:#d08770;">false</span><span>, </span><span style="color:#bf616a;">version </span><span>= &quot;</span><span style="color:#a3be8c;">0.5</span><span>&quot; }
</span><span>
</span><span style="color:#65737e;"># For example, useful to print the stack call of a raised error
</span><span style="color:#bf616a;">esp-backtrace </span><span>= { </span><span style="color:#bf616a;">default-features </span><span>= </span><span style="color:#d08770;">false</span><span>, </span><span style="color:#bf616a;">features </span><span>= [&quot;</span><span style="color:#a3be8c;">esp32</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">panic-handler</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">println</span><span>&quot;], </span><span style="color:#bf616a;">version </span><span>= &quot;</span><span style="color:#a3be8c;">0.14</span><span>&quot; }
</span><span>
</span><span style="color:#65737e;"># Contains the main features and structures
</span><span style="color:#bf616a;">esp-hal </span><span>= { </span><span style="color:#bf616a;">default-features </span><span>= </span><span style="color:#d08770;">false</span><span>, </span><span style="color:#bf616a;">features </span><span>= [&quot;</span><span style="color:#a3be8c;">esp32</span><span>&quot;], </span><span style="color:#bf616a;">version </span><span>= &quot;</span><span style="color:#a3be8c;">0.21</span><span>&quot; }
</span><span>
</span><span style="color:#65737e;"># Glue between Embassy and ESP
</span><span style="color:#bf616a;">esp-hal-embassy </span><span>= { </span><span style="color:#bf616a;">default-features </span><span>= </span><span style="color:#d08770;">false</span><span>, </span><span style="color:#bf616a;">features </span><span>= [&quot;</span><span style="color:#a3be8c;">esp32</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">executors</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">integrated-timers</span><span>&quot;], </span><span style="color:#bf616a;">version </span><span>= &quot;</span><span style="color:#a3be8c;">0.4</span><span>&quot; }
</span><span>
</span><span style="color:#65737e;"># Among other things, prints messages into the screen
</span><span style="color:#bf616a;">esp-println </span><span>= { </span><span style="color:#bf616a;">default-features </span><span>= </span><span style="color:#d08770;">false</span><span>, </span><span style="color:#bf616a;">features </span><span>= [&quot;</span><span style="color:#a3be8c;">auto</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">esp32</span><span>&quot;], </span><span style="color:#bf616a;">version </span><span>= &quot;</span><span style="color:#a3be8c;">0.12</span><span>&quot; }
</span><span>
</span><span style="color:#65737e;"># WiFi connectivity 
</span><span style="color:#bf616a;">esp-wifi </span><span>= { </span><span style="color:#bf616a;">default-features </span><span>= </span><span style="color:#d08770;">false</span><span>, </span><span style="color:#bf616a;">features </span><span>= [&quot;</span><span style="color:#a3be8c;">async</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">dhcpv4</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">embassy-net</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">esp32</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">esp-alloc</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">ipv4</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">tcp</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">wifi</span><span>&quot;], </span><span style="color:#bf616a;">version </span><span>= &quot;</span><span style="color:#a3be8c;">0.10</span><span>&quot; }
</span><span>
</span><span style="color:#65737e;"># Randomness generator
</span><span style="color:#bf616a;">rand </span><span>= { </span><span style="color:#bf616a;">default-features </span><span>= </span><span style="color:#d08770;">false</span><span>, </span><span style="color:#bf616a;">features </span><span>= [&quot;</span><span style="color:#a3be8c;">std_rng</span><span>&quot;], </span><span style="color:#bf616a;">version </span><span>= &quot;</span><span style="color:#a3be8c;">0.8</span><span>&quot; }
</span><span>
</span><span style="color:#65737e;"># Parses certificate files
</span><span style="color:#bf616a;">rustls-pemfile </span><span>= { </span><span style="color:#bf616a;">default-features </span><span>= </span><span style="color:#d08770;">false</span><span>, </span><span style="color:#bf616a;">version </span><span>= &quot;</span><span style="color:#a3be8c;">2.0</span><span>&quot; }
</span><span>
</span><span style="color:#65737e;"># Pins values in static memory
</span><span style="color:#bf616a;">static_cell </span><span>= { </span><span style="color:#bf616a;">default-features </span><span>= </span><span style="color:#d08770;">false</span><span>, </span><span style="color:#bf616a;">version </span><span>= &quot;</span><span style="color:#a3be8c;">2.0</span><span>&quot; }
</span><span>
</span><span style="color:#65737e;"># PostgreSQL client
</span><span style="color:#bf616a;">wtx </span><span>= { </span><span style="color:#bf616a;">default-features </span><span>= </span><span style="color:#d08770;">false</span><span>, </span><span style="color:#bf616a;">features </span><span>= [&quot;</span><span style="color:#a3be8c;">embassy-net</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">embedded-tls</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">portable-atomic-util</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">postgres</span><span>&quot;], </span><span style="color:#bf616a;">git </span><span>= &quot;</span><span style="color:#a3be8c;">https://github.com/c410-f3r/wtx</span><span>&quot; }
</span><span>
</span><span>[package]
</span><span style="color:#bf616a;">edition </span><span>= &quot;</span><span style="color:#a3be8c;">2021</span><span>&quot;
</span><span style="color:#bf616a;">name </span><span>= &quot;</span><span style="color:#a3be8c;">esp32-postgres</span><span>&quot;
</span><span style="color:#bf616a;">version </span><span>= &quot;</span><span style="color:#a3be8c;">0.1.0</span><span>&quot;
</span></code></pre>
<p>To finish, tweak parameters that drive the final binary size. The following snippet provides some suggestions but you can change them as much as you like.</p>
<pre data-lang="toml" style="background-color:#2b303b;color:#c0c5ce;" class="language-toml "><code class="language-toml" data-lang="toml"><span style="color:#65737e;"># Cargo.toml
</span><span>
</span><span>[profile.release]
</span><span style="color:#bf616a;">codegen-units </span><span>= </span><span style="color:#d08770;">1
</span><span style="color:#bf616a;">debug </span><span>= </span><span style="color:#d08770;">false
</span><span style="color:#bf616a;">debug-assertions </span><span>= </span><span style="color:#d08770;">false
</span><span style="color:#bf616a;">incremental </span><span>= </span><span style="color:#d08770;">false
</span><span style="color:#bf616a;">lto </span><span>= </span><span style="color:#d08770;">true
</span><span style="color:#bf616a;">opt-level </span><span>= &#39;</span><span style="color:#a3be8c;">z</span><span>&#39;
</span><span style="color:#bf616a;">overflow-checks </span><span>= </span><span style="color:#d08770;">false
</span><span style="color:#bf616a;">panic </span><span>= &#39;</span><span style="color:#a3be8c;">abort</span><span>&#39;
</span><span style="color:#bf616a;">rpath </span><span>= </span><span style="color:#d08770;">false
</span><span style="color:#bf616a;">strip </span><span>= &quot;</span><span style="color:#a3be8c;">symbols</span><span>&quot;
</span></code></pre>
<p>On an additional note, further size surplus can be cut using <code>cargo run -Z build-std-features="panic_immediate_abort" --release</code>.</p>
<h4 id="postgresql-server">PostgreSQL server</h4>
<p>At least for me, it is impressive to see an open-source project with almost ~30 years of existence still kicking in green field projects with no signs of stopping. That was one of the many reasons I chose <a href="https://www.postgresql.org">PostgreSQL</a> as the first database implementation within <a href="https://github.com/c410-f3r/wtx">WTX</a>.</p>
<p>As many others have done, we will use <code>openssl</code> to generate our RSA-based certificates for the TLS session. If you prefer, there are other tools with more user-friendly interfaces that do the same thing.</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#96b5b4;">set</span><span> -euxo pipefail
</span><span>
</span><span style="color:#bf616a;">CERTS_DIR</span><span>=&quot;</span><span style="color:#a3be8c;">/tmp</span><span>&quot;
</span><span style="color:#bf616a;">openssl</span><span> req</span><span style="color:#bf616a;"> -newkey</span><span> rsa:2048</span><span style="color:#bf616a;"> -nodes -subj </span><span>&quot;</span><span style="color:#a3be8c;">/C=FI/CN=vahid</span><span>&quot;</span><span style="color:#bf616a;"> -keyout </span><span>$</span><span style="color:#bf616a;">CERTS_DIR</span><span>/key.pem</span><span style="color:#bf616a;"> -out </span><span>$</span><span style="color:#bf616a;">CERTS_DIR</span><span>/key.csr
</span><span style="color:#bf616a;">openssl</span><span> x509</span><span style="color:#bf616a;"> -signkey </span><span>$</span><span style="color:#bf616a;">CERTS_DIR</span><span>/key.pem</span><span style="color:#bf616a;"> -in </span><span>$</span><span style="color:#bf616a;">CERTS_DIR</span><span>/key.csr</span><span style="color:#bf616a;"> -req -days</span><span> 365</span><span style="color:#bf616a;"> -out </span><span>$</span><span style="color:#bf616a;">CERTS_DIR</span><span>/cert.pem
</span><span style="color:#bf616a;">openssl</span><span> req</span><span style="color:#bf616a;"> -x509 -sha256 -nodes -subj </span><span>&quot;</span><span style="color:#a3be8c;">/C=FI/CN=vahid</span><span>&quot;</span><span style="color:#bf616a;"> -days</span><span> 365</span><span style="color:#bf616a;"> -newkey</span><span> rsa:2048</span><span style="color:#bf616a;"> -keyout </span><span>$</span><span style="color:#bf616a;">CERTS_DIR</span><span>/root-ca.key</span><span style="color:#bf616a;"> -out </span><span>$</span><span style="color:#bf616a;">CERTS_DIR</span><span>/root-ca.crt
</span><span style="color:#bf616a;">cat </span><span>&lt;&lt;&#39;</span><span style="color:#b48ead;">EOF</span><span>&#39; &gt;&gt; $</span><span style="color:#bf616a;">CERTS_DIR</span><span>/localhost.ext
</span><span style="color:#a3be8c;">authorityKeyIdentifier=keyid,issuer
</span><span style="color:#a3be8c;">basicConstraints=CA:FALSE
</span><span style="color:#a3be8c;">subjectAltName = @alt_names
</span><span style="color:#a3be8c;">[alt_names]
</span><span style="color:#a3be8c;">DNS.1 = localhost
</span><span style="color:#a3be8c;">IP.1 = 127.0.0.1
</span><span style="color:#b48ead;">EOF
</span><span style="color:#bf616a;">openssl</span><span> x509</span><span style="color:#bf616a;"> -req -CA </span><span>$</span><span style="color:#bf616a;">CERTS_DIR</span><span>/root-ca.crt</span><span style="color:#bf616a;"> -CAkey </span><span>$</span><span style="color:#bf616a;">CERTS_DIR</span><span>/root-ca.key</span><span style="color:#bf616a;"> -in </span><span>$</span><span style="color:#bf616a;">CERTS_DIR</span><span>/key.csr</span><span style="color:#bf616a;"> -out </span><span>$</span><span style="color:#bf616a;">CERTS_DIR</span><span>/cert.pem</span><span style="color:#bf616a;"> -days</span><span> 365</span><span style="color:#bf616a;"> -CAcreateserial -extfile </span><span>$</span><span style="color:#bf616a;">CERTS_DIR</span><span>/localhost.ext
</span><span style="color:#bf616a;">rm </span><span>$</span><span style="color:#bf616a;">CERTS_DIR</span><span>/key.csr
</span><span style="color:#bf616a;">rm </span><span>$</span><span style="color:#bf616a;">CERTS_DIR</span><span>/localhost.ext
</span><span style="color:#bf616a;">rm </span><span>$</span><span style="color:#bf616a;">CERTS_DIR</span><span>/root-ca.srl
</span></code></pre>
<p>With the root authority, server certificate and private key, it is time to create step-by-step a bash script that will be injected in the database at start-up time.</p>
<p>Again, if you prefer, there are other ways to achieve what we are going to do. See <a href="https://www.postgresql.org/docs/current/ssl-tcp.html">https://www.postgresql.org/docs/current/ssl-tcp.html</a>.</p>
<p>Create a file named "postgres.sh" and copy the contents of <code>root-ca.crt</code>.</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#96b5b4;">echo </span><span>&quot;</span><span style="color:#a3be8c;">-----BEGIN CERTIFICATE-----
</span><span style="color:#a3be8c;">MIIDGzCCAgOgAwIBAgIUNyNgj7AfQAqRUjCB/O1cEa9lLa8wDQYJKoZIhvcNAQEL
</span><span style="color:#a3be8c;">BQAwHTELMAkGA1UEBhMCRkkxDjAMBgNVBAMMBXZhaGlkMB4XDTI0MDUxNDEzMjEz
</span><span style="color:#a3be8c;">MVoXDTI1MDUxNDEzMjEzMVowHTELMAkGA1UEBhMCRkkxDjAMBgNVBAMMBXZhaGlk
</span><span style="color:#a3be8c;">MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAxv/ZvnUxusA2OK8cIkBJ
</span><span style="color:#a3be8c;">mwb6AmZJno2e7hRmrF5392xunAduQ124r4D/tkPDbUaRR+QoIJLLk3Jw2J3HRhXe
</span><span style="color:#a3be8c;">yFdEBw1eFNu6YsvRx/kB1PDw5uCalSAqvsD6Psbf2FwvL+fCvLtKP0ZxK0WrE41K
</span><span style="color:#a3be8c;">XqgoN0C9CpkBntOkV9C75raAldwfXQu5qK9ceJxVli1+UhYGKUBT4uhXnBhLFpaS
</span><span style="color:#a3be8c;">J32jq9KXrTRBQdcNmmBfzn66BkOaT40bc+e278AIJFJl+zhVRLNHmNuTJqOibe3i
</span><span style="color:#a3be8c;">5/UZv7I7ARu5/DjKVCp4P6xWvs1dgQXR/MdLuE/vBI2GxHyYB0mkTxb7Zeo2jKTL
</span><span style="color:#a3be8c;">mQIDAQABo1MwUTAdBgNVHQ4EFgQUfhKIY70FG/SrFsSFoC3RUfL/x6EwHwYDVR0j
</span><span style="color:#a3be8c;">BBgwFoAUfhKIY70FG/SrFsSFoC3RUfL/x6EwDwYDVR0TAQH/BAUwAwEB/zANBgkq
</span><span style="color:#a3be8c;">hkiG9w0BAQsFAAOCAQEAbiHGCVEdBAql37HYj+4yXo6wHS++jJnGB0QdhS9AFS5R
</span><span style="color:#a3be8c;">9hPvsDPJNnE7xg/FBuSOJocgGALqf0rv4yC8xQrd+3Xu/r+7RwpaQDvUklC8JuDD
</span><span style="color:#a3be8c;">giGPfT0qQVnL75im3AweLEWYTdUdogN++TlylJemqYxSFhe/eabWw+Gqp3VNlWOs
</span><span style="color:#a3be8c;">bdcdYFlf2K9UP2P+fKP+OZcX+RCddiujZ/Uh78PqZQDyl2r5yBRkS14LkgnB6mIy
</span><span style="color:#a3be8c;">oV56YBqDV8gL2cIGHcpmEeOLjcTUQs4IaB1HZIgWJTALOchTcaGcey8fS8wcdcFV
</span><span style="color:#a3be8c;">MImfF1qweImlnjrzlZaMLMjuGOL4bhbmmJSGmC9E/g==
</span><span style="color:#a3be8c;">-----END CERTIFICATE-----</span><span>&quot; &gt; $</span><span style="color:#bf616a;">PGDATA</span><span>/root-ca.crt
</span></code></pre>
<p>At start-up time the contents of the certificate will be inserted into the <code>$PGDATA/root-ca.crt</code> file. Do the same thing with <code>cert.pem</code> and <code>key.pem</code>.</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#96b5b4;">echo </span><span>&quot;</span><span style="color:#a3be8c;">-----BEGIN CERTIFICATE-----
</span><span style="color:#a3be8c;">MIIDMTCCAhmgAwIBAgIUCIvHpCaXTC3T1KFpBPyNv9zA4YswDQYJKoZIhvcNAQEL
</span><span style="color:#a3be8c;">BQAwHTELMAkGA1UEBhMCRkkxDjAMBgNVBAMMBXZhaGlkMB4XDTI0MDUxNDEzMjEz
</span><span style="color:#a3be8c;">MVoXDTI1MDUxNDEzMjEzMVowHTELMAkGA1UEBhMCRkkxDjAMBgNVBAMMBXZhaGlk
</span><span style="color:#a3be8c;">MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA8sHwVGIM6+UbxzqEK3Er
</span><span style="color:#a3be8c;">kJTmy0B7K7GId311GWUxiOXZNYzBku18Lr83VU+S/BebcYG8ehki5+clSTVRZ3K3
</span><span style="color:#a3be8c;">7893RUswRGf41Kyt2ZG+kq2s9RcN9FIy+4wOWb0TdHEjbrzpcT+IjkH8OpKyuQDw
</span><span style="color:#a3be8c;">/SqcNqTdkHwpZePEJMnM/EOmZvkaRH0qyKPua7BEdvI4q53y0ehGwmkSCdRGZV/w
</span><span style="color:#a3be8c;">Y4X/Scti5mHIzi12Tm09coCs7pFtwiQyELWwI89bem8qiHvQjMYPjt92xRap7IpY
</span><span style="color:#a3be8c;">sZlw5E+CZzJFE9HZG5oN8Diy0SlHcr+hFZD9ExOD6PowHI0Vuq4twA7Ad3B7u1SZ
</span><span style="color:#a3be8c;">uQIDAQABo2kwZzAfBgNVHSMEGDAWgBR+EohjvQUb9KsWxIWgLdFR8v/HoTAJBgNV
</span><span style="color:#a3be8c;">HRMEAjAAMBoGA1UdEQQTMBGCCWxvY2FsaG9zdIcEfwAAATAdBgNVHQ4EFgQUGrcs
</span><span style="color:#a3be8c;">/+p6jkHr/+ahxKWlqetgOpkwDQYJKoZIhvcNAQELBQADggEBABGzp6eeHf85bQNl
</span><span style="color:#a3be8c;">UvVAKh8vosrIsN5oFMjnTEMAJQBCoFzWFeRF70kEs2tVBG3A7NpbSs7va4fFb2gC
</span><span style="color:#a3be8c;">oplsP8NwZ8x7xGoKXmdb+3U9Toun5xkld8bUePNu4X8njQ8JH+LJ19Up3t5S/Ilm
</span><span style="color:#a3be8c;">+ZMbqQD5IMbSndqJBSGtmaoF5ijW1VA069UmMKUZdoiTwN51NuoFEqdqHfROhXhM
</span><span style="color:#a3be8c;">jo2qd4OgilcqJbaLX+A1WNuM0J/Jq1psX4xHjOnKDBiW376q7R8d9l2iv/sRs4tb
</span><span style="color:#a3be8c;">UdYdltMX2sG1EHGtNaSUZD9QK7VFrQ/A//js/75sKkyHDDyW6Ca8ZDIvweilPZFH
</span><span style="color:#a3be8c;">x5GYJig=
</span><span style="color:#a3be8c;">-----END CERTIFICATE-----</span><span>&quot; &gt; $</span><span style="color:#bf616a;">PGDATA</span><span>/cert.pem
</span><span style="color:#96b5b4;">echo </span><span>&quot;</span><span style="color:#a3be8c;">-----BEGIN PRIVATE KEY-----
</span><span style="color:#a3be8c;">MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDywfBUYgzr5RvH
</span><span style="color:#a3be8c;">OoQrcSuQlObLQHsrsYh3fXUZZTGI5dk1jMGS7XwuvzdVT5L8F5txgbx6GSLn5yVJ
</span><span style="color:#a3be8c;">NVFncrfvz3dFSzBEZ/jUrK3Zkb6Sraz1Fw30UjL7jA5ZvRN0cSNuvOlxP4iOQfw6
</span><span style="color:#a3be8c;">krK5APD9Kpw2pN2QfCll48Qkycz8Q6Zm+RpEfSrIo+5rsER28jirnfLR6EbCaRIJ
</span><span style="color:#a3be8c;">1EZlX/Bjhf9Jy2LmYcjOLXZObT1ygKzukW3CJDIQtbAjz1t6byqIe9CMxg+O33bF
</span><span style="color:#a3be8c;">FqnsilixmXDkT4JnMkUT0dkbmg3wOLLRKUdyv6EVkP0TE4Po+jAcjRW6ri3ADsB3
</span><span style="color:#a3be8c;">cHu7VJm5AgMBAAECggEARBVxfnEbd6ODlW5LeFWepsekLRgSE3CQuhaFG5C+gksY
</span><span style="color:#a3be8c;">jsTB25/ghsnZToNpUWubjIua3VGkcQ7qbaxW/uD1RnxU0qniSSUx7A/cGFuga8nq
</span><span style="color:#a3be8c;">6rhDESVmqBchRTjatnsuuVWhUUJE3cUS5SiUmH9zl0V2l3rIq0evYqStM7YnWA5j
</span><span style="color:#a3be8c;">TPcfTPD3BB24LmF6rCwSfYDZLhqtnI7EYaSjVOianiRDqVwtdjdIRqmAVgmG2itg
</span><span style="color:#a3be8c;">HquMK2eEpjNz9GbMOgw9qNW+oVR4VCatOPSHvDmOTWgBwO8elQsF0/YNwVrJN0MF
</span><span style="color:#a3be8c;">/XEFBoUCV6aXplRslOsOXI7VxbAaafl4C+MrLH7hIwKBgQD5sprhCCvmoA68wfg2
</span><span style="color:#a3be8c;">sJ0AeJKHNSmKxES7RlqUT2an4gKF5SLFdUlR6dwY3Tsij9fOhNfQeMMxz9vlt9Fx
</span><span style="color:#a3be8c;">FvAP8FPfIyQmmo7/M30zkKMeAOKiDSE0p/6IqpsGk/ECXRJ41X4OGTaL+2Pssrtl
</span><span style="color:#a3be8c;">U+el424wWxExAoJQRVJ/hUI3WwKBgQD44n217GOYiDNqqwakBNEK2ztn8y7X2+by
</span><span style="color:#a3be8c;">LaA4ZeDjaFOn47JGw3mhwWWffobLaR2Q2voGmG419LS9luLPbvzFhbP5QMDCArHY
</span><span style="color:#a3be8c;">VljZPiuX7/2itgxjpy6gU2ekrk1tWOnxhjAMBzNmh2fetDPWuVhwjz9baxPaSfaf
</span><span style="color:#a3be8c;">oQAWm+zTewKBgDGp54o4oNq3HRdIEUF3cVLFqIdB+KhED1OcU6nJ/SYJGu1cvMS/
</span><span style="color:#a3be8c;">ZjznocJERl3CdG78Fxy82D4RFLClFgBDSq4w482u5KLU/PofWJin/PmbvXfz2pXp
</span><span style="color:#a3be8c;">kAPIwxrU1AvfTSxBclgFhcbj0mUiy4kE3j8tdB4kDtBLqnWixBze+WOfAoGAPR9q
</span><span style="color:#a3be8c;">niYa45f3gKfV7qwcJp1mvoWzqGGiGzHnWlJy44Z4nQ/HdaeGFJqpeX0aX5RGJZAR
</span><span style="color:#a3be8c;">vVLsJiYdyT3oH+dy/pNyerFTZZJB2Q6DrX6eOCdBVBd/fW3OfqNdHc2MyGEAu0co
</span><span style="color:#a3be8c;">P5v5HKH+eWwqGv7T4Hjdp3bpnj9x6QwiOGs8w0cCgYEAllUcbP3C/ny2+wb1zE2Y
</span><span style="color:#a3be8c;">NoDhvas2dzuv/w3fb7xWxJCja+cjWuedvyn88g3n7d3ZwJoY6MbcNG42xdcDbFef
</span><span style="color:#a3be8c;">DfFDNISAIHpOuWdc9wJIXFuTZpCUGDTm3/qsl8ddjSnF3GLkj2nrbjdbnXX+EkKR
</span><span style="color:#a3be8c;">fKjjEhrpWlFz+k/9DZecURI=
</span><span style="color:#a3be8c;">-----END PRIVATE KEY-----</span><span>&quot; &gt; $</span><span style="color:#bf616a;">PGDATA</span><span>/key.pem
</span></code></pre>
<p>OK, now it is time to instruct <a href="https://www.postgresql.org">PostgreSQL</a> to make use of these certificates.</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">chmod</span><span> 0600 $</span><span style="color:#bf616a;">PGDATA</span><span>/key.pem
</span><span style="color:#bf616a;">cat </span><span>&gt;&gt; &quot;$</span><span style="color:#bf616a;">PGDATA</span><span style="color:#a3be8c;">/postgresql.conf</span><span>&quot; &lt;&lt;-</span><span style="color:#b48ead;">EOF
</span><span style="color:#a3be8c;">ssl = on
</span><span style="color:#a3be8c;">ssl_ca_file = &#39;root-ca.crt&#39;
</span><span style="color:#a3be8c;">ssl_cert_file = &#39;cert.pem&#39;
</span><span style="color:#a3be8c;">ssl_key_file = &#39;key.pem&#39;
</span><span style="color:#b48ead;">EOF
</span></code></pre>
<p>That is it! That is all you need to establish encrypted connections.</p>
<p>Since this script will be executed only once during start-up, we will use it to add the database user and its associated credentials. Additionally, the table that stores the readings from the DHT22 sensor will also be created.</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">cat </span><span>&gt; &quot;$</span><span style="color:#bf616a;">PGDATA</span><span style="color:#a3be8c;">/pg_hba.conf</span><span>&quot; &lt;&lt;-</span><span style="color:#b48ead;">EOF
</span><span style="color:#a3be8c;">host    all esp32   0.0.0.0/0   scram-sha-256
</span><span style="color:#a3be8c;">host    all esp32       ::0/0   scram-sha-256
</span><span style="color:#b48ead;">EOF
</span><span>
</span><span style="color:#bf616a;">psql -v</span><span> ON_ERROR_STOP=1</span><span style="color:#bf616a;"> --username </span><span>$</span><span style="color:#bf616a;">POSTGRES_USER </span><span>&lt;&lt;-</span><span style="color:#b48ead;">EOF
</span><span style="color:#a3be8c;">  SET password_encryption TO &#39;scram-sha-256&#39;;
</span><span style="color:#a3be8c;">  CREATE ROLE esp32 PASSWORD &#39;esp32&#39; LOGIN;
</span><span style="color:#a3be8c;">  GRANT ALL ON DATABASE esp32 TO esp32;
</span><span style="color:#a3be8c;">  ALTER DATABASE esp32 OWNER TO esp32;
</span><span style="color:#a3be8c;">  \c esp32 esp32
</span><span style="color:#a3be8c;">  CREATE TABLE sensor (
</span><span style="color:#a3be8c;">    id INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
</span><span style="color:#a3be8c;">    humidity FLOAT4 NOT NULL,
</span><span style="color:#a3be8c;">    temperature FLOAT4 NOT NULL
</span><span style="color:#a3be8c;">  );
</span><span style="color:#b48ead;">EOF
</span></code></pre>
<p>SCRAM-SHA-256 is a much more secure authentication method if compared with md5 because the actual password is not transmitting over the network. It works through a challenge-response mechanism where the client and server exchange password-related values created by cryptographic algorithms.</p>
<h2 id="coding">Coding</h2>
<p>The DHT22 sensor sends the <code>humidity</code> and <code>temperature</code> values to the ESP32 board, after that, we retrieve these values with the help of the official ESP32 crates and then everything is finally securely pushed to the remote <a href="https://www.postgresql.org">PostgreSQL</a> instance through the interacting of the <a href="https://github.com/c410-f3r/wtx">WTX</a> client.</p>
<p>It is recommended that you follow this section with the code available in the repository (<a href="https://github.com/c410-f3r/blog-posts">https://github.com/c410-f3r/blog-posts</a>).</p>
<figure class="image">
  <img src="/thoughts/securely-sending-dht22-sensor-data-from-an-esp32-board-to-postgresql/flow.jpg" alt="Flow">
</figure>
<p>Personally I am not proud but <code>unwrap()</code> was shamelessly used to accelerate development. However, you can create your own <code>Error</code> enum to centralize all the other third-party error types.</p>
<h4 id="initialization">Initialization</h4>
<p>It is necessary to first configure some parameters that will be used across the entire program execution cycle.</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#65737e;">// PostgreSQL URI like `postgres://esp32:esp32@127.0.0.1:5432/esp32?channel_binding=disable`
</span><span style="color:#b48ead;">let</span><span> uri_str = env!(&quot;</span><span style="color:#a3be8c;">URI</span><span>&quot;);
</span><span style="color:#65737e;">// WiFi password
</span><span style="color:#b48ead;">let</span><span> wifi_pw = env!(&quot;</span><span style="color:#a3be8c;">WIFI_PW</span><span>&quot;);
</span><span style="color:#65737e;">// WiFi identifier
</span><span style="color:#b48ead;">let</span><span> wifi_ssid = env!(&quot;</span><span style="color:#a3be8c;">WIFI_SSID</span><span>&quot;);
</span><span>
</span><span style="color:#65737e;">// Halts execution for certain durations
</span><span style="color:#b48ead;">let</span><span> delay = Delay::new();
</span><span style="color:#65737e;">// For example, GPIO, timers, etc...
</span><span style="color:#b48ead;">let</span><span> peripherals = esp_hal::init(esp_hal::Config::default());
</span><span style="color:#65737e;">// Random number generator provided by the board
</span><span style="color:#b48ead;">let</span><span> rng = Rng::new(peripherals.</span><span style="color:#d08770;">RNG</span><span>);
</span><span style="color:#65737e;">// will be discussed in the next section
</span><span style="color:#b48ead;">let </span><span>(rand_seed, stack_seed, xorshift64_seed) = </span><span style="color:#96b5b4;">seeds</span><span>(rng);
</span><span>
</span><span style="color:#65737e;">// Reserves a portion of the memory to allow heap allocations
</span><span>esp_alloc::heap_allocator!(</span><span style="color:#d08770;">64 </span><span>* </span><span style="color:#d08770;">1024</span><span>);
</span><span style="color:#65737e;">// Initializes embassy
</span><span>esp_hal_embassy::init(TimerGroup::new(peripherals.</span><span style="color:#d08770;">TIMG0</span><span>).timer0);
</span><span>
</span><span style="color:#65737e;">/// TCP buffer used to receive data
</span><span style="color:#b48ead;">let mut</span><span> rx_buffer_plain = [</span><span style="color:#d08770;">0</span><span>; </span><span style="color:#d08770;">2048</span><span>];
</span><span style="color:#65737e;">/// TLS buffer used to receive data
</span><span style="color:#b48ead;">let mut</span><span> rx_buffer_tls = [</span><span style="color:#d08770;">0</span><span>; </span><span style="color:#d08770;">8192</span><span>];
</span><span style="color:#65737e;">/// TCP buffer used to send data
</span><span style="color:#b48ead;">let mut</span><span> tx_buffer_plain = [</span><span style="color:#d08770;">0</span><span>; </span><span style="color:#d08770;">2048</span><span>];
</span><span style="color:#65737e;">/// TLS buffer used to send data
</span><span style="color:#b48ead;">let mut</span><span> tx_buffer_tls = [</span><span style="color:#d08770;">0</span><span>; </span><span style="color:#d08770;">8192</span><span>];
</span></code></pre>
<p>Not that complicated, right? Just a couple of static variables defined at compile-time alongside some mandatory elements.</p>
<p>What is complicated is the fact that <a href="https://embassy.dev/">Embassy</a>, <a href="https://github.com/drogue-iot/embedded-tls">Embedded-TLS</a> and <a href="https://github.com/c410-f3r/wtx">WTX</a> need different sources of seeds to generate random numbers. There are many ways to accomplish that and I will use the most straightforward method.</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">seeds</span><span>(</span><span style="color:#b48ead;">mut </span><span style="color:#bf616a;">rng</span><span>: Rng) -&gt; ([</span><span style="color:#b48ead;">u8</span><span>; 32], </span><span style="color:#b48ead;">u64</span><span>, </span><span style="color:#b48ead;">u64</span><span>) {
</span><span>  </span><span style="color:#b48ead;">let</span><span> rand_seed = {
</span><span>    </span><span style="color:#b48ead;">let </span><span>[</span><span style="color:#d08770;">_0</span><span>, </span><span style="color:#d08770;">_1</span><span>, </span><span style="color:#d08770;">_2</span><span>, </span><span style="color:#d08770;">_3</span><span>] = rng.</span><span style="color:#96b5b4;">random</span><span>().</span><span style="color:#96b5b4;">to_ne_bytes</span><span>();
</span><span>    </span><span style="color:#b48ead;">let </span><span>[</span><span style="color:#d08770;">_4</span><span>, </span><span style="color:#d08770;">_5</span><span>, </span><span style="color:#d08770;">_6</span><span>, </span><span style="color:#d08770;">_7</span><span>] = rng.</span><span style="color:#96b5b4;">random</span><span>().</span><span style="color:#96b5b4;">to_ne_bytes</span><span>();
</span><span>    </span><span style="color:#b48ead;">let </span><span>[</span><span style="color:#d08770;">_8</span><span>, </span><span style="color:#d08770;">_9</span><span>, </span><span style="color:#d08770;">_10</span><span>, </span><span style="color:#d08770;">_11</span><span>] = rng.</span><span style="color:#96b5b4;">random</span><span>().</span><span style="color:#96b5b4;">to_ne_bytes</span><span>();
</span><span>    </span><span style="color:#b48ead;">let </span><span>[</span><span style="color:#d08770;">_12</span><span>, </span><span style="color:#d08770;">_13</span><span>, </span><span style="color:#d08770;">_14</span><span>, </span><span style="color:#d08770;">_15</span><span>] = rng.</span><span style="color:#96b5b4;">random</span><span>().</span><span style="color:#96b5b4;">to_ne_bytes</span><span>();
</span><span>    </span><span style="color:#b48ead;">let </span><span>[</span><span style="color:#d08770;">_16</span><span>, </span><span style="color:#d08770;">_17</span><span>, </span><span style="color:#d08770;">_18</span><span>, </span><span style="color:#d08770;">_19</span><span>] = rng.</span><span style="color:#96b5b4;">random</span><span>().</span><span style="color:#96b5b4;">to_ne_bytes</span><span>();
</span><span>    </span><span style="color:#b48ead;">let </span><span>[</span><span style="color:#d08770;">_20</span><span>, </span><span style="color:#d08770;">_21</span><span>, </span><span style="color:#d08770;">_22</span><span>, </span><span style="color:#d08770;">_23</span><span>] = rng.</span><span style="color:#96b5b4;">random</span><span>().</span><span style="color:#96b5b4;">to_ne_bytes</span><span>();
</span><span>    </span><span style="color:#b48ead;">let </span><span>[</span><span style="color:#d08770;">_24</span><span>, </span><span style="color:#d08770;">_25</span><span>, </span><span style="color:#d08770;">_26</span><span>, </span><span style="color:#d08770;">_27</span><span>] = rng.</span><span style="color:#96b5b4;">random</span><span>().</span><span style="color:#96b5b4;">to_ne_bytes</span><span>();
</span><span>    </span><span style="color:#b48ead;">let </span><span>[</span><span style="color:#d08770;">_28</span><span>, </span><span style="color:#d08770;">_29</span><span>, </span><span style="color:#d08770;">_30</span><span>, </span><span style="color:#d08770;">_31</span><span>] = rng.</span><span style="color:#96b5b4;">random</span><span>().</span><span style="color:#96b5b4;">to_ne_bytes</span><span>();
</span><span>    [
</span><span>      </span><span style="color:#d08770;">_0</span><span>, </span><span style="color:#d08770;">_1</span><span>, </span><span style="color:#d08770;">_2</span><span>, </span><span style="color:#d08770;">_3</span><span>, </span><span style="color:#d08770;">_4</span><span>, </span><span style="color:#d08770;">_5</span><span>, </span><span style="color:#d08770;">_6</span><span>, </span><span style="color:#d08770;">_7</span><span>, </span><span style="color:#d08770;">_8</span><span>, </span><span style="color:#d08770;">_9</span><span>, </span><span style="color:#d08770;">_10</span><span>, </span><span style="color:#d08770;">_11</span><span>, </span><span style="color:#d08770;">_12</span><span>, </span><span style="color:#d08770;">_13</span><span>, </span><span style="color:#d08770;">_14</span><span>, </span><span style="color:#d08770;">_15</span><span>, </span><span style="color:#d08770;">_16</span><span>, </span><span style="color:#d08770;">_17</span><span>, </span><span style="color:#d08770;">_18</span><span>, </span><span style="color:#d08770;">_19</span><span>,
</span><span>      </span><span style="color:#d08770;">_20</span><span>, </span><span style="color:#d08770;">_21</span><span>, </span><span style="color:#d08770;">_22</span><span>, </span><span style="color:#d08770;">_23</span><span>, </span><span style="color:#d08770;">_24</span><span>, </span><span style="color:#d08770;">_25</span><span>, </span><span style="color:#d08770;">_26</span><span>, </span><span style="color:#d08770;">_27</span><span>, </span><span style="color:#d08770;">_28</span><span>, </span><span style="color:#d08770;">_29</span><span>, </span><span style="color:#d08770;">_30</span><span>, </span><span style="color:#d08770;">_31</span><span>,
</span><span>    ]
</span><span>  };
</span><span>  </span><span style="color:#b48ead;">let</span><span> stack_seed = {
</span><span>    </span><span style="color:#b48ead;">let </span><span>[</span><span style="color:#d08770;">_0</span><span>, </span><span style="color:#d08770;">_1</span><span>, </span><span style="color:#d08770;">_2</span><span>, </span><span style="color:#d08770;">_3</span><span>] = rng.</span><span style="color:#96b5b4;">random</span><span>().</span><span style="color:#96b5b4;">to_ne_bytes</span><span>();
</span><span>    </span><span style="color:#b48ead;">let </span><span>[</span><span style="color:#d08770;">_4</span><span>, </span><span style="color:#d08770;">_5</span><span>, </span><span style="color:#d08770;">_6</span><span>, </span><span style="color:#d08770;">_7</span><span>] = rng.</span><span style="color:#96b5b4;">random</span><span>().</span><span style="color:#96b5b4;">to_ne_bytes</span><span>();
</span><span>    </span><span style="color:#b48ead;">u64</span><span>::from_ne_bytes([</span><span style="color:#d08770;">_0</span><span>, </span><span style="color:#d08770;">_1</span><span>, </span><span style="color:#d08770;">_2</span><span>, </span><span style="color:#d08770;">_3</span><span>, </span><span style="color:#d08770;">_4</span><span>, </span><span style="color:#d08770;">_5</span><span>, </span><span style="color:#d08770;">_6</span><span>, </span><span style="color:#d08770;">_7</span><span>])
</span><span>  };
</span><span>  </span><span style="color:#b48ead;">let</span><span> xorshift64_seed = {
</span><span>    </span><span style="color:#b48ead;">let </span><span>[</span><span style="color:#d08770;">_0</span><span>, </span><span style="color:#d08770;">_1</span><span>, </span><span style="color:#d08770;">_2</span><span>, </span><span style="color:#d08770;">_3</span><span>] = rng.</span><span style="color:#96b5b4;">random</span><span>().</span><span style="color:#96b5b4;">to_ne_bytes</span><span>();
</span><span>    </span><span style="color:#b48ead;">let </span><span>[</span><span style="color:#d08770;">_4</span><span>, </span><span style="color:#d08770;">_5</span><span>, </span><span style="color:#d08770;">_6</span><span>, </span><span style="color:#d08770;">_7</span><span>] = rng.</span><span style="color:#96b5b4;">random</span><span>().</span><span style="color:#96b5b4;">to_ne_bytes</span><span>();
</span><span>    </span><span style="color:#b48ead;">u64</span><span>::from_ne_bytes([</span><span style="color:#d08770;">_0</span><span>, </span><span style="color:#d08770;">_1</span><span>, </span><span style="color:#d08770;">_2</span><span>, </span><span style="color:#d08770;">_3</span><span>, </span><span style="color:#d08770;">_4</span><span>, </span><span style="color:#d08770;">_5</span><span>, </span><span style="color:#d08770;">_6</span><span>, </span><span style="color:#d08770;">_7</span><span>])
</span><span>  };
</span><span>  (rand_seed, stack_seed, xorshift64_seed)
</span><span>}
</span></code></pre>
<p>The seeds are manually constructed using the RNG generator provided by the board, which is a bit laborious but does the job.</p>
<p>In regards to the array buffers, you can set any desired length, just be careful to not extrapolate the memory of your device.</p>
<h4 id="wifi-device">WiFi device</h4>
<p>The next step is to connect to the WiFi network with an IP using <code>esp_wifi</code>.</p>
<p>Please note that dropped connections are intentionally not handled because they are out of scope. If necessary, you will need to implement your own reconnection strategy.</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>async </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">wifi_device</span><span>(
</span><span>  </span><span style="color:#bf616a;">delay</span><span>: Delay,
</span><span>  </span><span style="color:#bf616a;">pw</span><span>: &amp;</span><span style="color:#b48ead;">str</span><span>,
</span><span>  </span><span style="color:#bf616a;">radio_clk</span><span>: RADIO_CLK,
</span><span>  </span><span style="color:#bf616a;">rng</span><span>: Rng,
</span><span>  </span><span style="color:#bf616a;">ssid</span><span>: &amp;</span><span style="color:#b48ead;">str</span><span>,
</span><span>  </span><span style="color:#bf616a;">timg1</span><span>: TIMG1,
</span><span>  </span><span style="color:#bf616a;">wifi</span><span>: WIFI,
</span><span>) -&gt; WifiDevice {
</span><span>  </span><span style="color:#b48ead;">let</span><span> timer0 = TimerGroup::new(timg1).timer0;
</span><span>  </span><span style="color:#65737e;">// Initializes WiFi instance
</span><span>  </span><span style="color:#b48ead;">let</span><span> init = esp_wifi::init(EspWifiInitFor::Wifi, timer0, rng, radio_clk).</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>  </span><span style="color:#b48ead;">let</span><span> config = wifi::ClientConfiguration {
</span><span>    </span><span style="color:#65737e;">// Uses AES
</span><span>    auth_method: AuthMethod::WPA2Personal,
</span><span>    </span><span style="color:#65737e;">// MAC address
</span><span>    bssid: None,
</span><span>    </span><span style="color:#65737e;">// No Channel
</span><span>    channel: None,
</span><span>    </span><span style="color:#65737e;">// Password retrieved from the environment variable
</span><span>    password: pw.</span><span style="color:#96b5b4;">try_into</span><span>().</span><span style="color:#96b5b4;">unwrap</span><span>(),
</span><span>    </span><span style="color:#65737e;">// Identifier retrieved from the environment variable
</span><span>    ssid: ssid.</span><span style="color:#96b5b4;">try_into</span><span>().</span><span style="color:#96b5b4;">unwrap</span><span>(),
</span><span>  };
</span><span>  </span><span style="color:#b48ead;">let </span><span>(rslt, </span><span style="color:#b48ead;">mut</span><span> controller) = wifi::new_with_config::&lt;WifiStaDevice&gt;(&amp;init, wifi, config).</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>  </span><span style="color:#65737e;">// Starts the WiFi controller.
</span><span>  controller.</span><span style="color:#96b5b4;">start</span><span>().await.</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>  </span><span style="color:#65737e;">// Waits 1 second
</span><span>  delay.</span><span style="color:#96b5b4;">delay</span><span>(</span><span style="color:#d08770;">1000.</span><span style="color:#96b5b4;">millis</span><span>());
</span><span>  </span><span style="color:#65737e;">// Connects the WiFi controller to a network
</span><span>  controller.</span><span style="color:#96b5b4;">connect</span><span>().await.</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>  rslt
</span><span>}
</span></code></pre>
<p>After the successful establishment of the WiFi connection, <a href="https://embassy.dev/">Embassy</a> (embassy-net) steps-in to request an IP address managed by DHCP.</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>async </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">wifi_device_configuration</span><span>(
</span><span>  </span><span style="color:#bf616a;">spawner</span><span>: Spawner,
</span><span>  </span><span style="color:#bf616a;">stack_seed</span><span>: </span><span style="color:#b48ead;">u64</span><span>,
</span><span>  </span><span style="color:#bf616a;">wifi_device</span><span>: WifiDevice,
</span><span>) -&gt; &amp;</span><span style="color:#b48ead;">&#39;static </span><span>Stack&lt;WifiDevice&gt; {
</span><span>  </span><span style="color:#65737e;">// Network stack handle
</span><span>  </span><span style="color:#b48ead;">let</span><span> wifi_device_stack = &amp;*</span><span style="color:#d08770;">STACK</span><span>.</span><span style="color:#96b5b4;">init</span><span>(Stack::new(
</span><span>    wifi_device,
</span><span>    </span><span style="color:#65737e;">// DHCP configuration
</span><span>    embassy_net::Config::dhcpv4({
</span><span>      </span><span style="color:#b48ead;">let mut</span><span> config = DhcpConfig::default();
</span><span>      config.hostname = Some(&quot;</span><span style="color:#a3be8c;">esp32-postgres</span><span>&quot;.</span><span style="color:#96b5b4;">try_into</span><span>().</span><span style="color:#96b5b4;">unwrap</span><span>());
</span><span>      config
</span><span>    }),
</span><span>    </span><span style="color:#d08770;">RESOURCES</span><span>.</span><span style="color:#96b5b4;">init</span><span>(StackResources::&lt;4&gt;::new()),
</span><span>    stack_seed,
</span><span>  ));
</span><span>  </span><span style="color:#65737e;">// Background task that handles WiFi packets
</span><span>  spawner.</span><span style="color:#96b5b4;">spawn</span><span>(</span><span style="color:#96b5b4;">wifi_runner</span><span>(wifi_device_stack)).</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>  </span><span style="color:#65737e;">// Waits for the network stack to obtain a valid IP configuration.
</span><span>  wifi_device_stack.</span><span style="color:#96b5b4;">wait_config_up</span><span>().await;
</span><span>  </span><span style="color:#65737e;">// Gets the current IPv4 configuration.
</span><span>  wifi_device_stack.</span><span style="color:#96b5b4;">config_v4</span><span>().</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>  wifi_device_stack
</span><span>}
</span><span>
</span><span>#[</span><span style="color:#bf616a;">embassy_executor</span><span>::</span><span style="color:#bf616a;">task</span><span>]
</span><span>async </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">wifi_runner</span><span>(</span><span style="color:#bf616a;">wifi_device</span><span>: &amp;</span><span style="color:#b48ead;">&#39;static </span><span>Stack&lt;WifiDevice&gt;) -&gt; ! {
</span><span>  wifi_device.</span><span style="color:#96b5b4;">run</span><span>().await
</span><span>}
</span></code></pre>
<h4 id="postgresql-client-wtx">PostgreSQL Client (WTX)</h4>
<p><a href="https://github.com/c410-f3r/wtx">WTX</a> is not hard-coded into a particular IO technology so we need to explicitly pass the <a href="https://embassy.dev/">Embassy</a> TCP socket as well as the <a href="https://github.com/drogue-iot/embedded-tls">Embedded-TLS</a> connector.</p>
<p>Thankfully the <code>rustls_pemfile</code> crate recently received <code>no_std</code> support to allow the parsing of the certificate authority (CA) file we generated in the setting-up block. Otherwise such a thing would probably have to be done manually.</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>async </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">executor</span><span>&lt;</span><span style="color:#b48ead;">&#39;plain</span><span>, </span><span style="color:#b48ead;">&#39;tls</span><span>, </span><span style="color:#b48ead;">&#39;wifi</span><span>&gt;(
</span><span>  </span><span style="color:#bf616a;">rand_seed</span><span>: [</span><span style="color:#b48ead;">u8</span><span>; 32],
</span><span>  </span><span style="color:#bf616a;">rx_buffer_plain</span><span>: &amp;</span><span style="color:#b48ead;">&#39;plain mut</span><span> [</span><span style="color:#b48ead;">u8</span><span>; 2048],
</span><span>  </span><span style="color:#bf616a;">rx_buffer_tls</span><span>: &amp;</span><span style="color:#b48ead;">&#39;tls mut</span><span> [</span><span style="color:#b48ead;">u8</span><span>; 8192],
</span><span>  </span><span style="color:#bf616a;">tx_buffer_plain</span><span>: &amp;</span><span style="color:#b48ead;">&#39;plain mut</span><span> [</span><span style="color:#b48ead;">u8</span><span>; 2048],
</span><span>  </span><span style="color:#bf616a;">tx_buffer_tls</span><span>: &amp;</span><span style="color:#b48ead;">&#39;tls mut</span><span> [</span><span style="color:#b48ead;">u8</span><span>; 8192],
</span><span>  </span><span style="color:#bf616a;">uri_str</span><span>: &amp;</span><span style="color:#b48ead;">str</span><span>,
</span><span>  </span><span style="color:#bf616a;">xorshift64_seed</span><span>: </span><span style="color:#b48ead;">u64</span><span>,
</span><span>  </span><span style="color:#bf616a;">wifi_device_stack</span><span>: &amp;</span><span style="color:#b48ead;">&#39;wifi </span><span>Stack&lt;WifiDevice&gt;,
</span><span>) -&gt; Executor&lt;wtx::Error, ExecutorBuffer, TlsConnection&lt;</span><span style="color:#b48ead;">&#39;tls</span><span>, TcpSocket&lt;</span><span style="color:#b48ead;">&#39;plain</span><span>&gt;, Aes128GcmSha256&gt;&gt;
</span><span style="color:#b48ead;">where
</span><span>  </span><span style="color:#b48ead;">&#39;plain</span><span>: </span><span style="color:#b48ead;">&#39;tls</span><span>,
</span><span>  </span><span style="color:#b48ead;">&#39;wifi</span><span>: </span><span style="color:#b48ead;">&#39;plain</span><span>,
</span><span>{
</span><span>  </span><span style="color:#65737e;">// Parses CA file
</span><span>  </span><span style="color:#b48ead;">let </span><span>Some((Item::X509Certificate(ca), _)) = rustls_pemfile::read_one_from_slice(</span><span style="color:#d08770;">CA</span><span>).</span><span style="color:#96b5b4;">unwrap</span><span>()
</span><span>  </span><span style="color:#b48ead;">else </span><span>{
</span><span>    panic!();
</span><span>  };
</span><span>  </span><span style="color:#65737e;">// Parsed URI
</span><span>  </span><span style="color:#b48ead;">let</span><span> uri = Uri::new(uri_str);
</span><span>  </span><span style="color:#65737e;">// TCP socket instance
</span><span>  </span><span style="color:#b48ead;">let mut</span><span> socket = TcpSocket::new(wifi_device_stack, rx_buffer_plain, tx_buffer_plain);
</span><span>  </span><span style="color:#65737e;">// Workaround due to the lack of `core::net::Ipv4Address` support within embassy
</span><span>  </span><span style="color:#b48ead;">let</span><span> ipv4_addr: Ipv4Addr = uri.</span><span style="color:#96b5b4;">hostname</span><span>().</span><span style="color:#96b5b4;">parse</span><span>().</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>  </span><span style="color:#b48ead;">let </span><span>[a, b, c, d] = ipv4_addr.</span><span style="color:#96b5b4;">octets</span><span>();
</span><span>  </span><span style="color:#65737e;">// Opens a TCP session
</span><span>  socket.</span><span style="color:#96b5b4;">connect</span><span>((Ipv4Address::new(a, b, c, d), uri.</span><span style="color:#96b5b4;">port</span><span>().</span><span style="color:#96b5b4;">unwrap</span><span>())).await.</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>  </span><span style="color:#65737e;">// Xorshift64 is a simple random number generator used by WTX
</span><span>  </span><span style="color:#b48ead;">let mut</span><span> xorshift64 = Xorshift64::from(xorshift64_seed);
</span><span>  Executor::&lt;wtx::Error, _, _&gt;::connect_encrypted(
</span><span>    </span><span style="color:#65737e;">// PostgreSQL configuration retrieved from the URI
</span><span>    &amp;wtx::database::client::postgres::Config::from_uri(&amp;uri).</span><span style="color:#96b5b4;">unwrap</span><span>(),
</span><span>    </span><span style="color:#65737e;">// Specific internal buffer that can be re-utilized across instances
</span><span>    ExecutorBuffer::new(</span><span style="color:#b48ead;">usize</span><span>::</span><span style="color:#d08770;">MAX</span><span>, &amp;</span><span style="color:#b48ead;">mut</span><span> xorshift64),
</span><span>    </span><span style="color:#65737e;">// Used to initialize hash maps
</span><span>    &amp;</span><span style="color:#b48ead;">mut</span><span> xorshift64,
</span><span>    </span><span style="color:#65737e;">// Allows the initial exchange of unencrypted data.
</span><span>    socket,
</span><span>    </span><span style="color:#65737e;">// After the initial handshake, WTX tries a TLS session
</span><span>    |stream| async {
</span><span>      </span><span style="color:#65737e;">// Pushes the certificate authority that was constructed using RSA algorithms
</span><span>      </span><span style="color:#b48ead;">let</span><span> config = TlsConfig::new().</span><span style="color:#96b5b4;">with_ca</span><span>(Certificate::</span><span style="color:#d08770;">X509</span><span>(ca.</span><span style="color:#96b5b4;">as_ref</span><span>())).</span><span style="color:#96b5b4;">enable_rsa_signatures</span><span>();
</span><span>      </span><span style="color:#65737e;">// TLS instance
</span><span>      </span><span style="color:#b48ead;">let mut</span><span> tls = TlsConnection::new(stream, rx_buffer_tls, tx_buffer_tls);
</span><span>      </span><span style="color:#65737e;">// Starts the TLS handshake with the `Aes128GcmSha256` schema.
</span><span>      tls
</span><span>        .</span><span style="color:#96b5b4;">open</span><span>(TlsContext::new(
</span><span>          &amp;config,
</span><span>          UnsecureProvider::new::&lt;Aes128GcmSha256&gt;(StdRng::from_seed(rand_seed)),
</span><span>        ))
</span><span>        .await
</span><span>        .</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>      </span><span style="color:#65737e;">// Returns the successful TLS instance
</span><span>      Ok(tls)
</span><span>    },
</span><span>  )
</span><span>  .await
</span><span>  .</span><span style="color:#96b5b4;">unwrap</span><span>()
</span><span>}
</span></code></pre>
<p><a href="https://www.postgresql.org">PostgreSQL</a> defines a set of interaction protocols and for some reason is necessary to first send the <code>80877103</code> number in an unencrypted TCP connection, thus the raison-d'être of the Executor's closure.</p>
<h4 id="sending-dht22-data-in-a-loop">Sending DHT22 data in a loop</h4>
<p>This is the final step, congratulations if you made this far.</p>
<p>The DHT22 sensor defines a sequence of high, low and waiting operations specified in the datasheet to read data. Luckily, you and I don't have to code and manually test such methods thanks to the <a href="https://github.com/kelnos/dht-embedded-rs">dht-embedded-rs</a> crate.</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#65737e;">// Initializes the sensor telling that communication should be performed through the GPIO pin
</span><span style="color:#65737e;">// number 32. Don&#39;t forget to change this value if you are using a different pin!
</span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">dht22</span><span>(</span><span style="color:#bf616a;">delay</span><span>: Delay, </span><span style="color:#bf616a;">gpio</span><span>: GPIO, </span><span style="color:#bf616a;">io_mux</span><span>: IO_MUX) -&gt; Dht22&lt;OutputOpenDrain&lt;</span><span style="color:#b48ead;">&#39;static</span><span>&gt;, Delay&gt; {
</span><span>  Dht22::new(OutputOpenDrain::new(Io::new(gpio, io_mux).pins.gpio32, Level::High, Pull::None), delay)
</span><span>}
</span></code></pre>
<p>Since the DHT22 sensor requires a 2-second interval between readings, we finalize our code with an infinite loop where in each iteration the program waits for the required interval, reads data, and then stores the humidity and temperature values in the PostgreSQL database.</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">loop </span><span>{
</span><span>  delay.</span><span style="color:#96b5b4;">delay</span><span>(</span><span style="color:#d08770;">2000.</span><span style="color:#96b5b4;">millis</span><span>());
</span><span>  </span><span style="color:#b48ead;">let</span><span> sensor_reading = dht22.</span><span style="color:#96b5b4;">read</span><span>().</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>  </span><span style="color:#b48ead;">let </span><span>_ = executor
</span><span>    .</span><span style="color:#96b5b4;">execute_with_stmt</span><span>(
</span><span>      &quot;</span><span style="color:#a3be8c;">INSERT INTO sensor (humidity, temperature) VALUES ($1, $2)</span><span>&quot;,
</span><span>      (sensor_reading.humidity, sensor_reading.temperature),
</span><span>    )
</span><span>    .await
</span><span>    .</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>}
</span></code></pre>
<p>Here goes a script for your convenience. Don't forget to insert the credentials of the WiFi.</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#65737e;">#!/usr/bin/env bash
</span><span>
</span><span style="color:#b48ead;">export </span><span style="color:#bf616a;">ESP_LOG</span><span>=&quot;</span><span style="color:#a3be8c;">INFO</span><span>&quot;
</span><span style="color:#b48ead;">export </span><span style="color:#bf616a;">URI</span><span>=&quot;</span><span style="color:#a3be8c;">postgres://esp32:esp32@127.0.0.1:5432/esp32?channel_binding=disable</span><span>&quot;
</span><span style="color:#b48ead;">export </span><span style="color:#bf616a;">WIFI_PW</span><span>=&quot;&quot;
</span><span style="color:#b48ead;">export </span><span style="color:#bf616a;">WIFI_SSID</span><span>=&quot;&quot;
</span><span>
</span><span style="color:#bf616a;">podman</span><span> rm</span><span style="color:#bf616a;"> -f</span><span> esp32
</span><span style="color:#bf616a;">podman</span><span> run \
</span><span style="color:#bf616a;">    -d </span><span>\
</span><span style="color:#bf616a;">    --name</span><span> esp32 \
</span><span style="color:#bf616a;">    -e</span><span> POSTGRES_DB=esp32 \
</span><span style="color:#bf616a;">    -e</span><span> POSTGRES_PASSWORD=esp32 \
</span><span style="color:#bf616a;">    -p</span><span> 5432:5432 \
</span><span style="color:#bf616a;">    -v</span><span> .scripts/postgres.sh:/docker-entrypoint-initdb.d/setup.sh \
</span><span>    docker.io/library/postgres:17
</span><span>
</span><span style="color:#bf616a;">cargo</span><span> run</span><span style="color:#bf616a;"> --release
</span></code></pre>
<h2 id="final-words">Final words</h2>
<figure class="image">
  <img src="/thoughts/securely-sending-dht22-sensor-data-from-an-esp32-board-to-postgresql/esp32.jpg" alt="ESP32">
</figure>
<p>That is it! You just established a remote <a href="https://www.postgresql.org">PostgreSQL</a> connection via WiFi using <code>SCRAM-SHA-256</code> without channel binding over a TLS 1.3 session encrypted with the <code>Aes128GcmSha256</code> cipher schema.</p>
<p>Although not as flexible, you no longer need to set-up an intermediary HTTP server on a x86-64 platform to proxy data storage.</p>
<p>To make good use of the camera that came with my development board, I will demonstrate (with enough time and motivation) how to implement real-time image streaming over <code>gRPC</code> in an upcoming post.</p>

        </div>
    </section>
</article>


            </main>

            <footer>
                <div class="columns is-vcentered">
                    <div class="column is-8">
                        Made with <a alt="Bulma" href="https://bulma.io/" target="_blank"><strong>Bulma</strong></a>
                        and
                        <a alt="Zola" href="https://www.getzola.org" target="_blank"><strong>Zola</strong></a>.
                    </div>
                    <div class="column">
                        <div>
                            <a href="https://github.com/c410-f3r" target="_blank" title="GitHub account">
                                <span class="icon-text">
                                    <span class="icon">
                                        <img alt="Github" src="/fontawesome/github.svg">
                                    </span>
                                    <span>c410-f3r</span>
                                </span>
                            </a>
                        </div>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <script type="text/javascript" src="https://c410-f3r.github.io/index.js"></script>
</body>

</html>